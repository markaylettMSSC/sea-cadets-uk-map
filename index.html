<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sea Cadets — UK Units (Full Map)</title>
  https://unpkg.com/leaflet@1.9.4/dist/leaflet.css
  https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css
  https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css
  <style>
    :root { --sc-blue:#0057B8; }
    html, body, #map { height: 100%; margin: 0; }
    .panel {
      position:absolute; top:10px; left:10px; background:#fff; padding:12px 14px;
      border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,.15);
      font:14px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial; max-width: 560px;
    }
    .panel h1 { font-size:16px; margin:0 0 6px; }
    .muted { color:#666; }
    .row { margin:10px 0; display:flex; gap:6px; flex-wrap:wrap; align-items:center; }
    .btn {
      display:inline-block; padding:7px 11px; background:var(--sc-blue); color:#fff; text-decoration:none;
      border-radius:6px; border:0; cursor:pointer;
    }
    .btn.secondary { background:#58667a; }
    .btn:disabled { background:#9bbbe3; cursor:not-allowed; }
    .mode { display:flex; gap:16px; align-items:center; }
    #status { margin-top:6px; color:#333; }
    .badge { background:var(--sc-blue); color:#fff; border-radius:4px; padding:0 6px; font-size:12px; }
    .paste {
      display:none; margin-top:6px;
    }
    .paste textarea {
      width:100%; min-height:140px; resize:vertical; padding:8px; font:12px/1.35 ui-monospace,SFMono-Regular,Consolas,Monaco,monospace;
      border:1px solid #ddd; border-radius:6px;
    }
    .help { font-size:12px; color:#444; }
    a { color:var(--sc-blue); }
    @media (max-width: 640px) {
      .panel { max-width: calc(100% - 20px); right:10px; }
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <div class="panel" role="region" aria-label="Map controls">
    <h1>Sea Cadets — UK Units (Full Map)</h1>
    <div class="muted">
      Builds from the official
      <a href="https://www.sea-cadets.org/units" target="_blank" rel="noopener">Unit Finder</a>
      and geocodes via <a href="https://postcodes.io/docs/overview/" target="_blank" rel="noopener">Postcodes.io</a>
      (<span class="badge">bulk</span>). Overseas entries are excluded.
    </div>

    <div class="row mode" role="radiogroup" aria-label="Build mode">
      <label><input type="radio" name="mode" value="live" checked /> Live (auto‑fetch)</label>
      <label><input type="radio" name="mode" value="paste" /> Paste mode (fallback)</label>
    </div>

    <div id="pasteWrap" class="paste" aria-hidden="true">
      <div class="help">
        Paste the text of the Unit Finder page here (Ctrl+A, Ctrl+C, then paste). Nothing leaves your browser.
      </div>
      <textarea id="pasteText" aria-label="Paste Unit Finder page text here"></textarea>
    </div>

    <div class="row">
      <button id="btnBuild" class="btn">Build map</button>
      <button id="btnZoomUK" class="btn secondary" type="button">Zoom UK</button>
      <button id="btnPNG" class="btn secondary" type="button">Export PNG</button>
      <button id="btnCSV" class="btn secondary" type="button">Download CSV</button>
      <button id="btnClear" class="btn secondary" type="button">Clear</button>
    </div>

    <div id="status" class="muted">Idle.</div>
  </div>

  https://unpkg.com/leaflet@1.9.4/dist/leaflet.js</script>
  https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js</script>
  https://unpkg.com/leaflet-image/leaflet-image.js</script>
  <script>
    // ---------- Config ----------
    const UK_COUNTRIES = new Set(['England','Scotland','Wales','Northern Ireland']);
    const TXT_ENDPOINTS = [
      // CORS-friendly text readers for the directory page
      'https://r.jina.ai/http://www.sea-cadets.org/units',
      'https://r.jina.ai/https://www.sea-cadets.org/units'
    ];

    // Regex
    const reUrl = /https?:\/\/www\.sea-cadets\.org\/([a-z0-9\-]+)/ig;
